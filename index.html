<!DOCTYPE html>
<html>
<head>
	<title>mobile</title>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    	<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
	<style type="text/css">
		body{
			margin: 0px;
			padding: 0px;
		}
		video{
			border: 1px solid red;
			width: 100%;
			height: 35em;
		}
		canvas{
			border: 1px solid red;
		}
		.firstbox{
			display: flex;
			padding: 0px;
			justify-content: flex-end;
		}
		.toobox{
			display: flex;
			padding: 0px;
			width: 100%;
			flex-direction: column;
			align-items: center;
		}
		ul{
			list-style: none;
		}
		.content_li{
			width: 99%;
		}
	</style>
</head>
<body>
	<ul class="firstbox">
		<li><button onclick="environment_cam()">후방 카메라</button></li>
		<li><button onclick="user_cam()">전방 카메라</button></li>
	</ul>
	<ul class="toobox">
		<li class="content_li" hidden="">
			<video id="video" autoplay></video>
		</li>
		<li><h2 id="Loding">Loding.........</h2></li>
		<li class="content_li">
			<canvas id="canvas"width="1000" height="1500" style="border:1px solid black; width: 100%; height: 100%;"></canvas>
		</li>
		
		<li>
			<input type="text" id="data" name="" value='과적테스트'>
			<span id="data1"></span>
		</li>
		<li>
			<canvas id="canvas_ai" width="200" height="250"></canvas>
		</li>
	</ul>
</body>
<script type="text/javascript">
	class mycanvas{
		constructor(width, height){
			this.canvas = document.getElementById('canvas');
			this.context = this.canvas.getContext('2d');
			this.canvas.width = width;
			this.canvas.height = height;
			this.x = 130;
			this.y = 100;
			this.xWidth = 200;
			this.yHeight = 200;
			
			this.canvas2 = document.getElementById('canvas_ai');
			this.context2 = this.canvas2.getContext('2d');
		}

		draw(video){
			this.context.globalAlpha = 0.2;
			this.context.drawImage(video,0, 0, this.canvas.width, this.canvas.height);
			this.context.globalAlpha = 1;
			this.context.drawImage(video, this.x, this.y, this.xWidth, this.yHeight, this.x, this.y, this.xWidth, this.yHeight);
			
			this.context2.drawImage(video, this.x, this.y, this.xWidth, this.yHeight, 0,0, 200, 250);
		}
	}
	let loadings;
	let indexdot = 0;
	function loading(num) {
		this.dot = [".","..","...","....","....."];
		document.getElementById('Loding').innerHTML = "Loding" + this.dot[num];
	}

	loadings = setInterval(frame, 1000);
	function frame() {
		indexdot++;
		if (indexdot > 4) {
			indexdot = 0;
		}
		loading(indexdot);
	}
	// Grab elements, create settings, etc.
	let video = document.getElementById('video');
	let camera;

	function environment_cam() {
		camera = { facingMode: { exact: "environment" } };
		cameraStream(camera);
	}
	function user_cam() {
		camera = { facingMode: "user" };
		cameraStream(camera);
	}
	environment_cam();
	function cameraStream(camera) {
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
	    	
	    	navigator.mediaDevices.getUserMedia({ video: camera }).then(function(stream) {
		        
		        video.srcObject = stream;
		        video.play();
		    });
	    }
	}

	const ks_canvas = new mycanvas(500, 500);
	video = document.getElementById('video');

	function snap () {
		ks_canvas.draw(video);
		predict();
		let data = ks_canvas.dataUrl;
	}
	const URL = "https://teachablemachine.withgoogle.com/models/pMhNlClaU/";

    let model, webcam, maxPredictions;
    // Load the image model and setup the webcam
    async function init() {
       
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        predict();
        alert("Ready ok");
      	clearInterval(loadings);
	document.getElementById('Loding').innerHTML = "";
	localStorage.setItem("test", "plzchapter");
    }
   
     async function predict() {
      
        var image = document.getElementById('canvas_ai');

        const prediction = await model.predict(image, false);
        
        let arrays = [];
         for (let i = 0; i < maxPredictions; i++) {
             const classPrediction =
             prediction[i].className + ": " + prediction[i].probability.toFixed(2);
             arrays[i] = prediction[i].probability.toFixed(2);
         }
         let carslaw = arrays[0];
         let truck = arrays[1];
         let car = arrays[2];
	 let excar = arrays[3];
         let ptroll = arrays[4];
         let sisul = arrays[5];
	 let way = arrays[6];    

         if ( carslaw > 0.90) {
            document.getElementById('data').value = "적재불량"
            document.getElementById('data1').innerHTML = carslaw * 100 + "%";
         }else if ( truck > 0.70) {
            document.getElementById('data').value = "화물차"
            document.getElementById('data1').innerHTML = truck * 100 + "%";
         }else if ( car > 0.70) {
            document.getElementById('data').value = "일반차량"
            document.getElementById('data1').innerHTML = car * 100 + "%";
         }else if ( excar > 0.70) {
            document.getElementById('data').value = "작업차량"
            document.getElementById('data1').innerHTML = excar * 100 + "%";
         }else if ( ptroll > 0.70) {
            document.getElementById('data').value = "순찰차"
            document.getElementById('data1').innerHTML = ptroll * 100 + "%";
         }else if ( sisul > 0.70) {
            document.getElementById('data').value = "시설물"
            document.getElementById('data1').innerHTML = sisul * 100 + "%";
         }else if ( way > 0.70) {
            document.getElementById('data').value = "노면"
            document.getElementById('data1').innerHTML = way * 100 + "%";
         }
         snap();
    }
init();
	
	

</script>
</html>
