<!DOCTYPE html>
<html>
<head>
	<title>mobile</title>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    	<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
	<style type="text/css">
		body{
			margin: 0px;
			padding: 0px;
		}
		video{
			border: 1px solid red;
			width: 100%;
			height: 35em;
		}
		canvas{
			border: 1px solid red;
		}
		.firstbox{
			display: flex;
			padding: 0px;
			justify-content: flex-end;
		}
		.toobox{
			display: flex;
			padding: 0px;
			width: 100%;
			flex-direction: column;
			align-items: center;
		}
		ul{
			list-style: none;
		}
		.content_li{
			width: 99%;
		}
	</style>
</head>
<body>
	<ul class="firstbox">
		<li><button onclick="environment_cam()">후방 카메라</button></li>
		<li><button onclick="user_cam()">전방 카메라</button></li>
	</ul>
	<ul class="toobox">
		<li class="content_li" hidden="">
			<video id="video" autoplay></video>
		</li>
		<li><h2 id="Loding">Loding.........</h2></li>
		<li class="content_li">
			<canvas id="canvas"width="1000" height="1500" style="border:1px solid black; width: 100%; height: 100%;"></canvas>
		</li>
		<li>
			<canvas id="canvas_ai" width="500" height="500"></canvas>
		</li>
		<li>
			< <button class="moveButton" onmousedown="up()" onmouseup="clearBt()" ontouchstart="up()" ontouchend="clearBt()">Up</button> <br>
            <button class="moveButton" onmousedown="left()" onmouseup="clearBt()" ontouchstart="left()" ontouchend="clearBt()"> <-- </button>
            <button class="moveButton" onmousedown="down()" onmouseup="clearBt()" ontouchstart="down()" ontouchend="clearBt()">down</button>
            <button class="moveButton" onmousedown="right()" onmouseup="clearBt()" ontouchstart="right()" ontouchend="clearBt()"> --> </button>
		</li>
		<li>
			<input type="text" id="data" name="" value='과적테스트'>
			<span id="data1"></span>
		</li>
	</ul>
</body>
<script type="text/javascript">
	class mycanvas{
		constructor(width, height){
			this.canvas = document.getElementById('canvas');
			this.context = this.canvas.getContext('2d');
			this.canvas.width = width;
			this.canvas.height = height;
			this.x = 0;
			this.y = 0;
			this.xWidth = 100;
			this.yHeight = 100;
		}

		draw(video){
			this.context.globalAlpha = 0.2;
			this.context.drawImage(video,0, 0, this.canvas.width, this.canvas.height);
			this.context.globalAlpha = 1;
			this.context.drawImage(video, this.x, this.y, this.xWidth, this.yHeight, this.x, this.y, this.xWidth, this.yHeight);
		}
	}
	let loadings;
	let indexdot = 0;
	function loading(num) {
		this.dot = [".","..","...","....","....."];
		document.getElementById('Loding').innerHTML = "Loding" + this.dot[num];
	}

	loadings = setInterval(frame, 1000);
	function frame() {
		indexdot++;
		if (indexdot > 4) {
			indexdot = 0;
		}
		loading(indexdot);
	}
	// Grab elements, create settings, etc.
	let video = document.getElementById('video');
	let camera;

	function environment_cam() {
		camera = { facingMode: { exact: "environment" } };
		cameraStream(camera);
	}
	function user_cam() {
		camera = { facingMode: "user" };
		cameraStream(camera);
	}
	environment_cam();
	function cameraStream(camera) {
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
	    	
	    	navigator.mediaDevices.getUserMedia({ video: camera }).then(function(stream) {
		        
		        video.srcObject = stream;
		        video.play();
		    });
	    }
	}

	const ks_canvas = new mycanvas(500, 500);
	video = document.getElementById('video');

	function snap () {
		ks_canvas.draw(video);
		predict();
		let data = ks_canvas.dataUrl;
	}
	const URL = "https://teachablemachine.withgoogle.com/models/XlpEGD_eD/";

    let model, webcam, maxPredictions;
    // Load the image model and setup the webcam
    async function init() {
       
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        predict();
        alert("Ready ok");
      	clearInterval(loadings);
	document.getElementById('Loding').innerHTML = "";
    }
   
     async function predict() {
      
        var image = document.getElementById('canvas');

        const prediction = await model.predict(image, false);
        
        let arrays = [];
         for (let i = 0; i < maxPredictions; i++) {
             const classPrediction =
             prediction[i].className + ": " + prediction[i].probability.toFixed(2);
             arrays[i] = prediction[i].probability.toFixed(2);
         }
         let cars = arrays[0];
         let shadows = arrays[1];
         let way = arrays[2];

         if ( cars > 0.79) {
            document.getElementById('data').value = "적재불량"
            document.getElementById('data1').innerHTML = cars * 100;
         }else if ( shadows > 0.70) {
            document.getElementById('data').value = "화물차"
            document.getElementById('data1').innerHTML = shadows * 100;
         }else if ( way > 0.70) {
            document.getElementById('data').value = "일반차량"
            document.getElementById('data1').innerHTML = way * 100;
         }
         snap();
    }
init();
	
	
	 ////////bt
     let button_start;

     function clearBt() {
        clearInterval(button_start);
    }
     function up() {
        button_start = setInterval(moveup, 30);
    }
    function moveup() {
        ks_canvas.x = ks_canvas.x - 5;
    }
    function left() {
        button_start = setInterval(moveleft, 30);
    }
    function moveleft() {
          ks_canvas.x = ks_canvas.x - 5;
    }
    function right() {
        button_start = setInterval(moveright, 30);
    }
    function moveright() {
        ks_canvas.x = ks_canvas.x + 5;
        
    function down() {
        button_start = setInterval(movedown, 30);
    }
    function movedown() {
        ks_canvas.y = ks_canvas.y + 5;
    }
</script>
</html>
